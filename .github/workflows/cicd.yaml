name: CI/CD - Build, Push, Test Docker App

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  docker-ci:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3️⃣ Build Docker image
      - name: Build Docker image
        run: |
          docker build -t 957gopi/cicd_chatbot:latest .

      # 4️⃣ Push Docker image (only on push, not PR)
      - name: Push Docker image
        if: github.event_name == 'push'
        run: |
          docker push 957gopi/cicd_chatbot:latest

      # 5️⃣ Run container with Gemini API key
      - name: Run container (test)
        run: |
          docker run -d -p 5000:5000 \
            -e GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
            --name test_app \
            957gopi/cicd_chatbot:latest
          sleep 10
          docker ps

      # 6️⃣ Check container logs
      - name: Check logs
        run: |
          docker logs test_app

      # 7️⃣ Stop & remove container
      - name: Cleanup
        run: |
          docker stop test_app
          docker rm test_app
